#!/bin/sh
if [ -z "${ACTION}" ] || [ -z "${KERNEL}" ]
then
    printf "This script does not support manual running!\n" 1>&2
    exit 1
fi

if [ "${ACTION}" = "change" ] && [ "${KERNEL}" = "sr0" ]
then
    if [ "${1}" != "child" ]
    then
        $(ACTION=${ACTION} KERNEL="${KERNEL}" setsid --fork ${0} child)
        exit 0
    fi
    if [ ! -f /home/pi/.lock ]
    then
        echo "${$}" > /home/pi/.lock
        logger "autorip-prelude running with PID ${$}"
    else
        logger "Killing prior instance of autorip-prelude"
        kill $(cat /home/pi/.lock) # The drive has been pulled so we should probably terminate it..
        exit 0
    fi
    cdrom=$(volname)
    if [ -z "${cdrom}" ]
    then
        autorip "${cdrom}"
        cdrom="${cdrom}.iso"
    else
        if [ -f "unknown-iso.iso" ]
        then
            i=1
            while [ "${i}" -lt 9999 ]
            do
                if [ ! -f "unknown-iso-${i}.iso" ]
                then
                    break
                fi
                i=$(($i+1))
            done
            autorip "unknown-iso-${i}"
            md5=$(md5sum "unknown-iso-${i}.iso")
            cdrom="unknown-iso-${i}.iso"
            unset i
        else
            autorip "unknown-iso"
            cdrom="unknown-iso.iso"
            md5=$(md5sum "unknown-iso.iso")
        fi
    fi
    eject
    verify-backend md5="${md5}" "${cdrom}"
    rm /home/pi/.lock
fi
